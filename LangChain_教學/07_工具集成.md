# ç¬¬ä¸ƒç« ï¼šå·¥å…·é›†æˆ

æœ¬ç« å°‡ä»‹ç´¹å¦‚ä½•åœ¨ LangChain 2.0 ä¸­å°‡å¤–éƒ¨å·¥å…·èˆ‡èªè¨€æ¨¡å‹é›†æˆï¼Œå¤§å¤§æ“´å±• AI æ‡‰ç”¨çš„åŠŸèƒ½ç¯„åœã€‚

## 7.1 å·¥å…·çš„æ¦‚å¿µ

å·¥å…·ï¼ˆToolsï¼‰å…è¨±èªè¨€æ¨¡å‹åŸ·è¡Œè«¸å¦‚æœç´¢ç¶²çµ¡ã€åŸ·è¡Œè¨ˆç®—ã€è¨ªå•æ•¸æ“šåº«ç­‰å¯¦éš›æ“ä½œã€‚LangChain 2.0 æä¾›äº†æ¨™æº–åŒ–çš„æ–¹å¼ä¾†å®šç¾©å’Œä½¿ç”¨å·¥å…·ï¼š

- å·¥å…·æ˜¯å¸¶æœ‰è¼¸å…¥/è¼¸å‡ºçš„å‡½æ•¸
- èªè¨€æ¨¡å‹å¯ä»¥åŸºæ–¼ç”¨æˆ¶éœ€æ±‚é¸æ“‡é©ç•¶çš„å·¥å…·
- å·¥å…·åŸ·è¡Œçµæœå¯ä»¥å›é¥‹çµ¦æ¨¡å‹ç”¢ç”Ÿæ›´ç²¾ç¢ºçš„å›æ‡‰

## 7.2 å‰µå»ºåŸºæœ¬å·¥å…·

åœ¨ LangChain ä¸­ï¼Œå·¥å…·æ˜¯ç”±å‡½æ•¸å’Œå…ƒæ•¸æ“šçµ„æˆçš„ï¼š

```python
from langchain.tools import tool

@tool
def search(query: str) -> str:
    """æœç´¢ç¶²çµ¡ä»¥ç²å–æœ‰é—œç‰¹å®šä¸»é¡Œçš„ä¿¡æ¯ã€‚"""
    # é€™è£¡æ˜¯ä¸€å€‹æ¨¡æ“¬çš„æœç´¢åŠŸèƒ½
    return f"é€™æ˜¯é—œæ–¼'{query}'çš„æœç´¢çµæœ..."

@tool
def calculator(expression: str) -> str:
    """è¨ˆç®—æ•¸å­¸è¡¨é”å¼çš„çµæœã€‚"""
    try:
        return str(eval(expression))
    except Exception as e:
        return f"è¨ˆç®—éŒ¯èª¤: {str(e)}"
```

## 7.3 å…§ç½®å·¥å…·

LangChain æä¾›äº†è¨±å¤šå…§ç½®å·¥å…·ï¼š

```python
from langchain.agents.tools import Tool
from langchain_community.tools import WikipediaQueryRun
from langchain_community.utilities import WikipediaAPIWrapper

# ç¶­åŸºç™¾ç§‘æŸ¥è©¢å·¥å…·
wikipedia_tool = WikipediaQueryRun(api_wrapper=WikipediaAPIWrapper())

# åŒ…è£æˆæ¨™æº–å·¥å…·
wikipedia = Tool(
    name="Wikipedia",
    description="æœç´¢ç¶­åŸºç™¾ç§‘ç²å–ä¿¡æ¯",
    func=wikipedia_tool.run
)
```

## 7.4 å·¥å…·èˆ‡ä»£ç†çµåˆ

å·¥å…·æ˜¯å¼·å¤§çš„ï¼Œä½†çœŸæ­£çš„åŠ›é‡ä¾†è‡ªæ–¼å°‡å·¥å…·èˆ‡èªè¨€æ¨¡å‹çµåˆï¼Œå‰µå»ºèƒ½å¤ æ±ºå®šä½•æ™‚ä½¿ç”¨å·¥å…·çš„ä»£ç†ï¼š

```python
from langchain.agents import AgentExecutor, create_react_agent
from langchain_community.llms import Ollama
from langchain_core.prompts import PromptTemplate

# åˆå§‹åŒ– LLM
llm = Ollama(model="llama2")

# å®šç¾©å·¥å…·åˆ—è¡¨
tools = [search, calculator]

# å‰µå»ºæç¤ºæ¨¡æ¿
prompt = PromptTemplate.from_template("""
ä½ æ˜¯ä¸€å€‹èƒ½å¤ ä½¿ç”¨å·¥å…·è§£æ±ºå•é¡Œçš„åŠ©æ‰‹ã€‚
å¯ç”¨å·¥å…·:
{tools}

ä½¿ç”¨ä»¥ä¸‹æ ¼å¼:
å•é¡Œ: ç”¨æˆ¶çš„å•é¡Œ
æ€è€ƒ: ä½ å°å¦‚ä½•è§£æ±ºå•é¡Œçš„æ€è€ƒ
è¡Œå‹•: å·¥å…·åç¨± (å·¥å…·åƒæ•¸)
è§€å¯Ÿ: å·¥å…·è¿”å›çš„çµæœ
æ€è€ƒ: ä½ å°çµæœçš„æ€è€ƒ
è¡Œå‹•: å·¥å…·åç¨± (å·¥å…·åƒæ•¸)
è§€å¯Ÿ: å·¥å…·è¿”å›çš„çµæœ
...
å›ç­”: æœ€çµ‚å›ç­”

å•é¡Œ: {input}
""")

# å‰µå»ºä»£ç†
agent = create_react_agent(llm, tools, prompt)

# å‰µå»ºä»£ç†åŸ·è¡Œå™¨
agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=True)

# é‹è¡Œä»£ç†
result = agent_executor.invoke({"input": "è¨ˆç®— (53 * 19) ä¸¦å‘Šè¨´æˆ‘é€™å€‹æ•¸å­—çš„å¹³æ–¹æ ¹æ˜¯å¤šå°‘"})
print(result["output"])
```

## 7.5 Ollama èˆ‡å·¥å…·é›†æˆ

ç”±æ–¼ Ollama æä¾›çš„æ¨¡å‹å¯èƒ½ä¸åƒä¸€äº›å•†æ¥­æ¨¡å‹é‚£æ¨£å®Œå…¨æ”¯æŒä»£ç†åŠŸèƒ½ï¼Œæˆ‘å€‘å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ç­–ç•¥ï¼š

### 7.5.1 çµæ§‹åŒ–è¼¸å‡ºè§£æ

å®šç¾©å·¥å…·é¸æ“‡çš„æ ¼å¼ï¼Œä¸¦ä½¿ç”¨è¼¸å‡ºè§£æå™¨è§£ææ¨¡å‹å›æ‡‰ï¼š

```python
from langchain_core.pydantic_v1 import BaseModel, Field
from langchain_core.output_parsers import PydanticOutputParser

# å®šç¾©å·¥å…·é¸æ“‡æ¶æ§‹
class ToolSelection(BaseModel):
    tool_name: str = Field(description="è¦ä½¿ç”¨çš„å·¥å…·åç¨±")
    tool_input: str = Field(description="å‚³å…¥å·¥å…·çš„åƒæ•¸")

# å‰µå»ºè§£æå™¨
parser = PydanticOutputParser(pydantic_object=ToolSelection)

# å‰µå»ºå·¥å…·é¸æ“‡æç¤º
tool_prompt = PromptTemplate.from_template("""
ä½ éœ€è¦é¸æ“‡æœ€åˆé©çš„å·¥å…·ä¾†å›ç­”ç”¨æˆ¶çš„å•é¡Œã€‚

å¯ç”¨å·¥å…·:
- search: æœç´¢ç¶²çµ¡ä»¥ç²å–æœ‰é—œç‰¹å®šä¸»é¡Œçš„ä¿¡æ¯
- calculator: è¨ˆç®—æ•¸å­¸è¡¨é”å¼çš„çµæœ

ç”¨æˆ¶å•é¡Œ: {question}

{format_instructions}
""")

# å·¥å…·é¸æ“‡éˆ
tool_selection_chain = (
    tool_prompt.format(
        question="{question}",
        format_instructions=parser.get_format_instructions()
    )
    | llm
    | parser
)

# ä½¿ç”¨å·¥å…·é¸æ“‡
def use_tools(question):
    try:
        # é¸æ“‡å·¥å…·
        selection = tool_selection_chain.invoke({"question": question})
        tool_name = selection.tool_name
        tool_input = selection.tool_input
        
        # åŸ·è¡Œå·¥å…·
        if tool_name == "search":
            tool_result = search(tool_input)
        elif tool_name == "calculator":
            tool_result = calculator(tool_input)
        else:
            tool_result = "æœªçŸ¥å·¥å…·"
            
        # ç”Ÿæˆæœ€çµ‚å›æ‡‰
        final_prompt = f"""
        ç”¨æˆ¶å•é¡Œ: {question}
        
        å·¥å…·çµæœ: {tool_result}
        
        è«‹åŸºæ–¼å·¥å…·çµæœæä¾›å®Œæ•´å›ç­”ã€‚
        """
        
        return llm.invoke(final_prompt)
    
    except Exception as e:
        # å¦‚æœè§£æå¤±æ•—ï¼Œç›´æ¥ä½¿ç”¨ LLM å›ç­”
        return llm.invoke(f"è«‹å›ç­”ä»¥ä¸‹å•é¡Œ: {question}")
```

### 7.5.2 è‡ªå®šç¾©å·¥å…·åŸ·è¡Œæµç¨‹

å°æ–¼æ›´è¤‡é›œçš„å ´æ™¯ï¼Œå¯ä»¥æ‰‹å‹•å¯¦ç¾å·¥å…·é¸æ“‡å’ŒåŸ·è¡Œçš„æµç¨‹ï¼š

```python
def execute_tools_workflow(question):
    # ç¬¬ä¸€æ­¥ï¼šåˆ†æå•é¡Œä»¥ç¢ºå®šæ˜¯å¦éœ€è¦å·¥å…·
    analysis_prompt = f"åˆ†æä»¥ä¸‹å•é¡Œæ˜¯å¦éœ€è¦ä½¿ç”¨ç‰¹æ®Šå·¥å…·ä¾†å›ç­”: '{question}'. åªå›ç­”'éœ€è¦'æˆ–'ä¸éœ€è¦'ã€‚"
    needs_tool = "éœ€è¦" in llm.invoke(analysis_prompt)
    
    if not needs_tool:
        # ç›´æ¥å›ç­”
        return llm.invoke(f"è«‹å›ç­”: {question}")
    
    # ç¬¬äºŒæ­¥ï¼šæ±ºå®šä½¿ç”¨å“ªå€‹å·¥å…·
    tool_selection_prompt = f"""
    å•é¡Œ: '{question}'
    å¾ä»¥ä¸‹å·¥å…·ä¸­é¸æ“‡æœ€åˆé©çš„ä¸€å€‹ä¾†å›ç­”å•é¡Œ:
    1. search - æœç´¢ç¶²çµ¡ç²å–ä¿¡æ¯
    2. calculator - åŸ·è¡Œæ•¸å­¸è¨ˆç®—
    åªå›ç­”æ•¸å­—1æˆ–2ã€‚
    """
    
    tool_choice = llm.invoke(tool_selection_prompt).strip()
    
    # ç¬¬ä¸‰æ­¥ï¼šç²å–å·¥å…·åƒæ•¸
    param_prompt = f"å•é¡Œ: '{question}'. è«‹æå–å‡ºéœ€è¦å‚³å…¥å·¥å…·çš„å…·é«”åƒæ•¸ï¼Œä¸è¦åŒ…å«å…¶ä»–è§£é‡‹ã€‚"
    tool_param = llm.invoke(param_prompt).strip()
    
    # ç¬¬å››æ­¥ï¼šåŸ·è¡Œå·¥å…·
    if "1" in tool_choice:
        tool_result = search(tool_param)
    else:
        tool_result = calculator(tool_param)
    
    # ç¬¬äº”æ­¥ï¼šç”Ÿæˆæœ€çµ‚å›æ‡‰
    final_prompt = f"""
    ç”¨æˆ¶å•é¡Œ: {question}
    
    å·¥å…·çµæœ: {tool_result}
    
    è«‹åŸºæ–¼å·¥å…·çµæœæä¾›å®Œæ•´å›ç­”ã€‚
    """
    
    return llm.invoke(final_prompt)
```

## 7.6 è¤‡é›œå·¥å…·é›†æˆ

### 7.6.1 ç¶²é ç€è¦½å·¥å…·

```python
from langchain_community.tools import BrowserTool

browser = BrowserTool()

def browse_website(url: str) -> str:
    """è¨ªå•ç¶²é ä¸¦æå–ä¸»è¦å…§å®¹ã€‚"""
    return browser.run(url)
```

### 7.6.2 æ–‡æª”æŸ¥è©¢å·¥å…·

```python
from langchain.text_splitter import CharacterTextSplitter
from langchain_community.vectorstores import FAISS
from langchain_community.embeddings import OllamaEmbeddings
from langchain.chains import RetrievalQA

def create_document_tool(file_path):
    # åŠ è¼‰æ–‡æª”
    with open(file_path, 'r') as file:
        text = file.read()
    
    # åˆ‡åˆ†æ–‡æª”
    text_splitter = CharacterTextSplitter(chunk_size=1000, chunk_overlap=0)
    chunks = text_splitter.split_text(text)
    
    # å‰µå»ºå‘é‡å­˜å„²
    embeddings = OllamaEmbeddings(model="llama2")
    vectorstore = FAISS.from_texts(chunks, embeddings)
    
    # å‰µå»º QA éˆ
    qa_chain = RetrievalQA.from_chain_type(
        llm=Ollama(model="llama2"),
        chain_type="stuff",
        retriever=vectorstore.as_retriever()
    )
    
    @tool
    def document_qa(query: str) -> str:
        """å¾æ–‡æª”ä¸­æŸ¥è©¢ä¿¡æ¯ã€‚"""
        return qa_chain.run(query)
    
    return document_qa
```

## 7.7 å·¥å…·ä½¿ç”¨å¯¦ä¾‹

ä»¥ä¸‹æ˜¯å¹¾å€‹å·¥å…·ä½¿ç”¨çš„å®Œæ•´å¯¦ä¾‹ï¼Œå±•ç¤ºå¦‚ä½•åœ¨å¯¦éš›æ‡‰ç”¨ä¸­é›†æˆå’Œä½¿ç”¨ä¸åŒé¡å‹çš„å·¥å…·ã€‚

### 7.7.1 å¤©æ°£æŸ¥è©¢å·¥å…·

ä½¿ç”¨ OpenWeatherMap API å‰µå»ºä¸€å€‹å¤©æ°£æŸ¥è©¢å·¥å…·ï¼š

```python
import requests
from langchain.tools import tool

# éœ€è¦å…ˆç²å– API å¯†é‘°: https://openweathermap.org/
API_KEY = "your_openweathermap_api_key"

@tool
def get_weather(location: str) -> str:
    """ç²å–æŒ‡å®šåŸå¸‚çš„ç•¶å‰å¤©æ°£æƒ…æ³ã€‚"""
    try:
        url = f"http://api.openweathermap.org/data/2.5/weather?q={location}&appid={API_KEY}&units=metric"
        response = requests.get(url)
        data = response.json()
        
        if response.status_code == 200:
            weather = data["weather"][0]["description"]
            temp = data["main"]["temp"]
            humidity = data["main"]["humidity"]
            wind_speed = data["wind"]["speed"]
            
            return f"""
            {location}çš„ç•¶å‰å¤©æ°£:
            - å¤©æ°£ç‹€æ³: {weather}
            - æº«åº¦: {temp}Â°C
            - æ¿•åº¦: {humidity}%
            - é¢¨é€Ÿ: {wind_speed} m/s
            """
        else:
            return f"ç„¡æ³•ç²å–å¤©æ°£æ•¸æ“š: {data.get('message', 'æœªçŸ¥éŒ¯èª¤')}"
    except Exception as e:
        return f"æŸ¥è©¢å¤©æ°£æ™‚ç™¼ç”ŸéŒ¯èª¤: {str(e)}"

# ä½¿ç”¨ä¾‹å­
if __name__ == "__main__":
    city = "å°åŒ—"
    print(get_weather(city))
```

### 7.7.2 çµåˆå¤šå·¥å…·çš„å•ç­”ç³»çµ±

çµåˆæœç´¢ã€è¨ˆç®—å™¨å’Œå¤©æ°£å·¥å…·çš„å®Œæ•´å•ç­”ç³»çµ±ï¼š

```python
from langchain.agents import AgentExecutor, create_react_agent
from langchain_community.llms import Ollama
from langchain_core.prompts import PromptTemplate
from langchain.tools import tool

# åˆå§‹åŒ–LLM
llm = Ollama(model="llama2")

# å®šç¾©å·¥å…·
@tool
def search(query: str) -> str:
    """æœç´¢ç¶²çµ¡ä»¥ç²å–æœ‰é—œç‰¹å®šä¸»é¡Œçš„ä¿¡æ¯ã€‚"""
    # åœ¨çœŸå¯¦æ‡‰ç”¨ä¸­ï¼Œé€™è£¡å¯ä»¥æ¥å…¥ Google Search API æˆ–å…¶ä»–æœç´¢æœå‹™
    return f"é€™æ˜¯é—œæ–¼'{query}'çš„æ¨¡æ“¬æœç´¢çµæœï¼š{query}æ˜¯ä¸€å€‹ç†±é–€è©±é¡Œ..."

@tool
def calculator(expression: str) -> str:
    """è¨ˆç®—æ•¸å­¸è¡¨é”å¼çš„çµæœã€‚"""
    try:
        return str(eval(expression))
    except Exception as e:
        return f"è¨ˆç®—éŒ¯èª¤: {str(e)}"

@tool
def get_date_time() -> str:
    """ç²å–ç•¶å‰æ—¥æœŸå’Œæ™‚é–“ã€‚"""
    from datetime import datetime
    now = datetime.now()
    return now.strftime("%Y-%m-%d %H:%M:%S")

# å‰µå»ºæç¤ºæ¨¡æ¿
prompt = PromptTemplate.from_template("""
ä½ æ˜¯ä¸€å€‹èƒ½å¤ ä½¿ç”¨å·¥å…·è§£æ±ºå•é¡Œçš„æ™ºèƒ½åŠ©æ‰‹ã€‚

å¯ç”¨å·¥å…·:
{tools}

ä½¿ç”¨ä»¥ä¸‹æ ¼å¼:
å•é¡Œ: ç”¨æˆ¶çš„å•é¡Œ
æ€è€ƒ: ä½ å°å¦‚ä½•è§£æ±ºå•é¡Œçš„æ€è€ƒ
è¡Œå‹•: å·¥å…·åç¨± (å·¥å…·åƒæ•¸)
è§€å¯Ÿ: å·¥å…·è¿”å›çš„çµæœ
æ€è€ƒ: ä½ å°çµæœçš„æ€è€ƒ
è¡Œå‹•: å·¥å…·åç¨± (å·¥å…·åƒæ•¸)
è§€å¯Ÿ: å·¥å…·è¿”å›çš„çµæœ
...
å›ç­”: æœ€çµ‚å›ç­”

å•é¡Œ: {input}
""")

# å‰µå»ºä»£ç†
agent = create_react_agent(llm, [search, calculator, get_date_time], prompt)

# å‰µå»ºä»£ç†åŸ·è¡Œå™¨
agent_executor = AgentExecutor(agent=agent, tools=[search, calculator, get_date_time], verbose=True)

# ä¸»ç¨‹åº
def main():
    print("ğŸ¤– å¤šåŠŸèƒ½åŠ©æ‰‹å·²å•Ÿå‹• (è¼¸å…¥'é€€å‡º'çµæŸ)")
    print("å¯ç”¨åŠŸèƒ½: æœç´¢ä¿¡æ¯ã€æ•¸å­¸è¨ˆç®—ã€æŸ¥è©¢ç•¶å‰æ™‚é–“")
    
    while True:
        user_input = input("\nè«‹è¼¸å…¥æ‚¨çš„å•é¡Œ: ")
        if user_input.lower() in ["é€€å‡º", "exit", "quit"]:
            print("æ„Ÿè¬ä½¿ç”¨ï¼å†è¦‹ï¼")
            break
            
        try:
            result = agent_executor.invoke({"input": user_input})
            print("\nå›ç­”:", result["output"])
        except Exception as e:
            print(f"è™•ç†è«‹æ±‚æ™‚å‡ºéŒ¯: {str(e)}")
            print("è«‹å˜—è©¦é‡æ–°è¡¨è¿°æ‚¨çš„å•é¡Œã€‚")

if __name__ == "__main__":
    main()
```

### 7.7.3 PDFæ–‡ä»¶åˆ†æå·¥å…·

å‰µå»ºä¸€å€‹èƒ½å¤ è®€å–ã€åˆ†æPDFæ–‡ä»¶ä¸¦å›ç­”ç›¸é—œå•é¡Œçš„å·¥å…·ï¼š

```python
import os
from langchain_community.document_loaders import PyPDFLoader
from langchain.text_splitter import RecursiveCharacterTextSplitter
from langchain_community.vectorstores import FAISS
from langchain_community.embeddings import OllamaEmbeddings
from langchain.tools import tool
from langchain.chains import ConversationalRetrievalChain
from langchain_community.llms import Ollama

class PDFAnalysisTool:
    def __init__(self, model_name="llama2"):
        self.llm = Ollama(model=model_name)
        self.embeddings = OllamaEmbeddings(model=model_name)
        self.text_splitter = RecursiveCharacterTextSplitter(
            chunk_size=1000,
            chunk_overlap=200
        )
        self.vectorstore = None
        self.qa_chain = None
        self.loaded_file = None
        
    def load_pdf(self, pdf_path):
        """è¼‰å…¥PDFæ–‡ä»¶ä¸¦å‰µå»ºå‘é‡å­˜å„²"""
        if not os.path.exists(pdf_path):
            return f"éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°æ–‡ä»¶ {pdf_path}"
        
        try:
            # è¼‰å…¥PDF
            loader = PyPDFLoader(pdf_path)
            documents = loader.load()
            
            # æ–‡ä»¶åˆ†å¡Š
            chunks = self.text_splitter.split_documents(documents)
            
            # å‰µå»ºå‘é‡å­˜å„²
            self.vectorstore = FAISS.from_documents(chunks, self.embeddings)
            
            # å‰µå»ºå•ç­”éˆ
            self.qa_chain = ConversationalRetrievalChain.from_llm(
                self.llm,
                retriever=self.vectorstore.as_retriever(),
                return_source_documents=True
            )
            
            self.loaded_file = pdf_path
            return f"æˆåŠŸè¼‰å…¥æ–‡ä»¶: {os.path.basename(pdf_path)}"
        
        except Exception as e:
            return f"è¼‰å…¥PDFæ™‚å‡ºéŒ¯: {str(e)}"
    
    @tool
    def ask_pdf(self, query_with_path: str) -> str:
        """æŸ¥è©¢PDFæ–‡ä»¶å…§å®¹ã€‚æ ¼å¼ï¼š'æ–‡ä»¶è·¯å¾‘::å•é¡Œ'"""
        try:
            # è§£æè¼¸å…¥
            parts = query_with_path.split("::", 1)
            if len(parts) != 2:
                return "æŸ¥è©¢æ ¼å¼ä¸æ­£ç¢ºã€‚è«‹ä½¿ç”¨'æ–‡ä»¶è·¯å¾‘::å•é¡Œ'æ ¼å¼ã€‚"
                
            pdf_path, query = parts
            
            # å¦‚æœæ˜¯æ–°æ–‡ä»¶æˆ–å°šæœªè¼‰å…¥æ–‡ä»¶ï¼Œå‰‡è¼‰å…¥PDF
            if self.loaded_file != pdf_path:
                load_result = self.load_pdf(pdf_path)
                if load_result.startswith("éŒ¯èª¤"):
                    return load_result
            
            # æŸ¥è©¢PDFå…§å®¹
            if self.qa_chain:
                result = self.qa_chain({"question": query, "chat_history": []})
                
                # æå–å¼•ç”¨çš„é ç¢¼
                page_numbers = []
                for doc in result.get("source_documents", []):
                    if "page" in doc.metadata:
                        page_numbers.append(doc.metadata["page"])
                
                return f"""
                å›ç­”: {result["answer"]}
                
                å¼•ç”¨é ç¢¼: {', '.join(map(str, set(page_numbers)))}
                """
            else:
                return "è«‹å…ˆè¼‰å…¥PDFæ–‡ä»¶ã€‚"
                
        except Exception as e:
            return f"æŸ¥è©¢PDFæ™‚å‡ºéŒ¯: {str(e)}"

# ä½¿ç”¨ä¾‹å­
if __name__ == "__main__":
    pdf_tool = PDFAnalysisTool()
    
    # å®šç¾©å·¥å…·åˆ—è¡¨
    tools = [pdf_tool.ask_pdf]
    
    # å‰µå»ºä»£ç†
    llm = Ollama(model="llama2")
    prompt = PromptTemplate.from_template("""
    ä½ æ˜¯ä¸€å€‹PDFæ–‡ä»¶åˆ†æåŠ©æ‰‹ï¼Œå¯ä»¥å›ç­”é—œæ–¼PDFæ–‡ä»¶å…§å®¹çš„å•é¡Œã€‚
    
    å¯ç”¨å·¥å…·:
    {tools}
    
    ä½¿ç”¨ä»¥ä¸‹æ ¼å¼:
    å•é¡Œ: ç”¨æˆ¶çš„å•é¡Œ
    æ€è€ƒ: ä½ å°å¦‚ä½•è§£æ±ºå•é¡Œçš„æ€è€ƒ
    è¡Œå‹•: å·¥å…·åç¨± (å·¥å…·åƒæ•¸)
    è§€å¯Ÿ: å·¥å…·è¿”å›çš„çµæœ
    æ€è€ƒ: ä½ å°çµæœçš„æ€è€ƒ
    å›ç­”: æœ€çµ‚å›ç­”
    
    å•é¡Œ: {input}
    """)
    
    agent = create_react_agent(llm, tools, prompt)
    agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=True)
    
    # ç¤ºä¾‹ä½¿ç”¨
    pdf_path = "/path/to/your/document.pdf"
    result = agent_executor.invoke({
        "input": f"è«‹å¹«æˆ‘ç¸½çµ{pdf_path}é€™å€‹æ–‡ä»¶çš„ä¸»è¦å…§å®¹"
    })
    print(result["output"])
```

### 7.7.4 æ··åˆå·¥å…·ä½¿ç”¨çš„çµ‚ç«¯æ‡‰ç”¨

å‰µå»ºä¸€å€‹èƒ½å¤ ä½¿ç”¨å¤šç¨®å·¥å…·çš„çµ‚ç«¯æ‡‰ç”¨ï¼š

```python
import sys
import argparse
from rich.console import Console
from rich.markdown import Markdown
from langchain.agents import AgentExecutor, create_react_agent
from langchain_community.llms import Ollama
from langchain_core.prompts import PromptTemplate
from langchain.tools import tool
import requests
from datetime import datetime

console = Console()

# åˆå§‹åŒ– LLM
def get_llm(model_name="llama2"):
    try:
        return Ollama(model=model_name)
    except Exception as e:
        console.print(f"[bold red]éŒ¯èª¤: ç„¡æ³•è¼‰å…¥æ¨¡å‹ {model_name}[/bold red]")
        console.print(f"è©³æƒ…: {str(e)}")
        sys.exit(1)

# å®šç¾©å·¥å…·é›†
@tool
def search_web(query: str) -> str:
    """æœç´¢ç¶²çµ¡ç²å–ä¿¡æ¯ï¼ˆæ¨¡æ“¬ï¼‰"""
    return f"é€™æ˜¯é—œæ–¼'{query}'çš„æœç´¢çµæœã€‚åœ¨çœŸå¯¦æ‡‰ç”¨ä¸­ï¼Œé€™è£¡æœƒè¿”å›çœŸå¯¦çš„ç¶²çµ¡æœç´¢çµæœã€‚"

@tool
def calculate(expression: str) -> str:
    """åŸ·è¡Œæ•¸å­¸è¨ˆç®—"""
    try:
        return str(eval(expression))
    except Exception as e:
        return f"è¨ˆç®—éŒ¯èª¤: {str(e)}"

@tool
def get_current_time() -> str:
    """ç²å–ç•¶å‰æ—¥æœŸå’Œæ™‚é–“"""
    now = datetime.now()
    return now.strftime("%Y-%m-%d %H:%M:%S")

@tool
def translate_text(text: str) -> str:
    """ç¿»è­¯æ–‡æœ¬ï¼ˆæ¨¡æ“¬ï¼‰"""
    # åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œå¯ä»¥æ¥å…¥çœŸå¯¦çš„ç¿»è­¯API
    return f"é€™æ˜¯'{text}'çš„ç¿»è­¯çµæœã€‚åœ¨çœŸå¯¦æ‡‰ç”¨ä¸­ï¼Œé€™è£¡æœƒè¿”å›å¯¦éš›çš„ç¿»è­¯å…§å®¹ã€‚"

@tool
def summarize_text(text: str) -> str:
    """ç¸½çµé•·æ–‡æœ¬"""
    # åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œå¯ä»¥ä½¿ç”¨LLMä¾†å¯¦ç¾æ–‡æœ¬ç¸½çµ
    return f"é€™æ˜¯å°æ–‡æœ¬çš„ç¸½çµã€‚åœ¨çœŸå¯¦æ‡‰ç”¨ä¸­ï¼Œæˆ‘å€‘æœƒèª¿ç”¨LLMä¾†ç”ŸæˆçœŸå¯¦çš„ç¸½çµã€‚"

def create_agent(llm, tools):
    """å‰µå»ºä»£ç†"""
    prompt = PromptTemplate.from_template("""
    ä½ æ˜¯ä¸€å€‹æ™ºèƒ½åŠ©æ‰‹ï¼Œèƒ½å¤ ä½¿ç”¨å„ç¨®å·¥å…·ä¾†å¹«åŠ©ç”¨æˆ¶è§£æ±ºå•é¡Œã€‚
    
    å¯ç”¨å·¥å…·:
    {tools}
    
    ä½¿ç”¨ä»¥ä¸‹æ ¼å¼:
    å•é¡Œ: ç”¨æˆ¶çš„å•é¡Œ
    æ€è€ƒ: ä½ å°å¦‚ä½•è§£æ±ºå•é¡Œçš„æ€è€ƒ
    è¡Œå‹•: å·¥å…·åç¨± (å·¥å…·åƒæ•¸)
    è§€å¯Ÿ: å·¥å…·è¿”å›çš„çµæœ
    æ€è€ƒ: ä½ å°çµæœçš„æ€è€ƒ
    è¡Œå‹•: å·¥å…·åç¨± (å·¥å…·åƒæ•¸)
    è§€å¯Ÿ: å·¥å…·è¿”å›çš„çµæœ
    ...
    å›ç­”: æœ€çµ‚å›ç­”
    
    å›ç­”æ™‚ä½¿ç”¨markdownæ ¼å¼ï¼Œè®“è¼¸å‡ºæ›´æ˜“è®€ã€‚
    
    å•é¡Œ: {input}
    """)
    
    agent = create_react_agent(llm, tools, prompt)
    return AgentExecutor(agent=agent, tools=tools, verbose=False)

def main():
    # è§£æå‘½ä»¤è¡Œåƒæ•¸
    parser = argparse.ArgumentParser(description="å¤šåŠŸèƒ½å·¥å…·åŠ©æ‰‹")
    parser.add_argument("--model", default="llama2", help="è¦ä½¿ç”¨çš„Ollamaæ¨¡å‹åç¨±")
    args = parser.parse_args()
    
    # åˆå§‹åŒ–LLMå’Œå·¥å…·
    llm = get_llm(args.model)
    tools = [search_web, calculate, get_current_time, translate_text, summarize_text]
    
    # å‰µå»ºä»£ç†
    agent_executor = create_agent(llm, tools)
    
    # æ‡‰ç”¨æ¨™é¡Œ
    console.print("[bold blue]===== å¤šåŠŸèƒ½å·¥å…·åŠ©æ‰‹ =====[/bold blue]")
    console.print("å¯ç”¨å‘½ä»¤: /help, /exit")
    console.print("å¯ç”¨å·¥å…·: ç¶²é æœç´¢, æ•¸å­¸è¨ˆç®—, æ™‚é–“æŸ¥è©¢, æ–‡æœ¬ç¿»è­¯, æ–‡æœ¬ç¸½çµ")
    
    # ä¸»å¾ªç’°
    chat_history = []
    while True:
        try:
            # ç²å–ç”¨æˆ¶è¼¸å…¥
            user_input = console.input("\n[bold green]å•é¡Œ: [/bold green]")
            
            # è™•ç†ç‰¹æ®Šå‘½ä»¤
            if user_input.lower() in ["/exit", "/quit"]:
                console.print("[yellow]æ„Ÿè¬ä½¿ç”¨ï¼Œå†è¦‹![/yellow]")
                break
                
            if user_input.lower() == "/help":
                console.print("""
                [bold]å¯ç”¨å‘½ä»¤:[/bold]
                /help - é¡¯ç¤ºæ­¤å¹«åŠ©ä¿¡æ¯
                /exit - é€€å‡ºç¨‹åº
                
                [bold]å·¥å…·ä½¿ç”¨ä¾‹å­:[/bold]
                - "è¨ˆç®— (156 * 42) / 3.5 çš„çµæœ"
                - "ç¾åœ¨æ˜¯ä»€éº¼æ™‚é–“ï¼Ÿ"
                - "æœç´¢é—œæ–¼é‡å­è¨ˆç®—çš„è³‡è¨Š"
                - "å¹«æˆ‘ç¿»è­¯é€™æ®µæ–‡æœ¬ï¼šHello, how are you?"
                - "ç¸½çµä»¥ä¸‹å…§å®¹ï¼š...ï¼ˆé•·æ–‡æœ¬ï¼‰..."
                """)
                continue
            
            # ä»£ç†è™•ç†å•é¡Œ
            start_time = datetime.now()
            console.print("[dim]æ€è€ƒä¸­...[/dim]")
            
            response = agent_executor.invoke({"input": user_input})
            
            # è¨ˆç®—éŸ¿æ‡‰æ™‚é–“
            end_time = datetime.now()
            time_diff = (end_time - start_time).total_seconds()
            
            # é¡¯ç¤ºå›ç­”
            console.print("\n[bold]å›ç­”:[/bold]")
            console.print(Markdown(response["output"]))
            console.print(f"[dim]è™•ç†æ™‚é–“: {time_diff:.2f}ç§’[/dim]")
            
            # æ›´æ–°èŠå¤©è¨˜éŒ„
            chat_history.append((user_input, response["output"]))
            
        except KeyboardInterrupt:
            console.print("\n[yellow]ç¨‹åºå·²ä¸­æ–·ï¼Œæ„Ÿè¬ä½¿ç”¨ï¼[/yellow]")
            break
            
        except Exception as e:
            console.print(f"[bold red]ç™¼ç”ŸéŒ¯èª¤:[/bold red] {str(e)}")

if __name__ == "__main__":
    main()
```

## 7.8 ä½¿ç”¨ç¤ºä¾‹ä»£ç¢¼

æœ¬ç« çš„å·¥å…·é›†æˆç¤ºä¾‹å¯ä»¥åœ¨ `examples/tools_example.py` ä¸­æ‰¾åˆ°ï¼š

```bash
python examples/tools_example.py
```

## ä¸‹ä¸€æ­¥

å­¸ç¿’äº†å¦‚ä½•é›†æˆå·¥å…·å¾Œï¼Œè®“æˆ‘å€‘åœ¨ä¸‹ä¸€ç« ç¯€ä¸­æ¢ç´¢å¯¦éš›æ‡‰ç”¨æ¡ˆä¾‹ï¼Œå°‡ä¹‹å‰å­¸åˆ°çš„æ‰€æœ‰æŠ€è¡“çµåˆèµ·ä¾†æ§‹å»ºå®Œæ•´çš„æ‡‰ç”¨ã€‚
